<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>選擇排序法：詳細視覺化 (左側代碼版)</title>
    <style>
        :root {
            --sorted-color: #2ecc71;      
            --unsorted-color: #bdc3c7;    
            --min-color: #e74c3c;         
            --compare-color: #f1c40f;     
            --code-bg: #282c34;           
            --text-color: #2c3e50;
            --accent-color: #3498db;
            --loop-outer: #e67e22;        /* 外循環顏色 (橘) */
            --loop-inner: #9b59b6;        /* 內循環顏色 (紫) */
            --line-height: 34px;          /* 定義每行代碼的高度以便計算 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin-bottom: 10px; text-align: center; }
        p.subtitle { margin-top: 0; color: #666; margin-bottom: 20px; text-align: center; }

        /* 主容器：左右佈局 */
        .main-container {
            display: flex;
            flex-direction: row; 
            gap: 20px;
            width: 100%;
            max-width: 1400px; /* 加寬整體容器 */
            justify-content: center;
            align-items: flex-start;
        }

        /* 左側：代碼與變量區塊 (加大空間) */
        .left-panel {
            flex: 1.2; /* 增加權重，使其更寬 */
            min-width: 480px; /* 設定最小寬度 */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 右側：視覺化區塊 */
        .visualizer-section {
            flex: 1.5; 
            min-width: 400px;
        }

        .visualization-box {
            display: flex;
            justify-content: center;
            height: 420px; /* 增加高度以容納堆疊的標記 */
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px 20px 60px 20px; /* 底部留白給 i, j, min 標記 */
            align-items: flex-end;
            position: relative;
        }

        /* 變量儀表板 */
        .variable-dashboard {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .var-box {
            background: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .var-label { font-size: 12px; color: #666; margin-bottom: 4px; font-weight: bold; }
        .var-value { font-family: 'Courier New', monospace; font-size: 16px; font-weight: bold; color: #333; }
        .var-sub { font-size: 10px; color: #999; }

        /* 代碼區塊 */
        .code-section {
            background-color: var(--code-bg);
            color: #abb2bf;
            padding: 20px 20px 20px 45px; /* 左側留白給循環線 */
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-family: 'Courier New', Courier, monospace; 
            position: relative;
            overflow: hidden;
            font-size: 15px; /* 稍微加大字體 */
        }

        .code-line {
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: pre; /* 保持縮排 */
            line-height: 26px; 
            height: var(--line-height); 
            box-sizing: border-box;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
        }

        /* 循環指示線 */
        .loop-indicator {
            position: absolute;
            left: 10px;
            border-left: 3px solid;
            border-top: 3px solid;
            border-bottom: 3px solid;
            width: 12px;
            opacity: 0.8;
            pointer-events: none;
            z-index: 1;
        }
        
        .loop-label {
            position: absolute;
            font-size: 11px; 
            transform: rotate(-90deg);
            transform-origin: left bottom;
            white-space: nowrap;
            font-weight: bold;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        /* 外循環: 行 1 中間 (37px) 至 行 7 中間 (241px) */
        .loop-outer {
            border-color: var(--loop-outer);
            top: 37px;  
            height: 204px; 
            left: 12px;
        }
        .loop-outer .loop-label {
            color: var(--loop-outer);
            bottom: 10px; left: -2px;
        }

        /* 內循環: 行 3 中間 (105px) 至 行 5 中間 (173px) */
        .loop-inner {
            border-color: var(--loop-inner);
            top: 105px;     
            height: 68px;
            left: 24px;
        }
        .loop-inner .loop-label {
            color: var(--loop-inner);
            bottom: 10px; left: -2px;
        }

        .code-line.active { background-color: var(--compare-color); color: #000; font-weight: bold; }
        .code-line.active-red { background-color: var(--min-color); color: white; }
        .code-line.active-green { background-color: var(--sorted-color); color: white; }

        .line-num {
            display: inline-block;
            width: 20px;
            color: #5c6370;
            text-align: right;
            margin-right: 10px;
            user-select: none;
            flex-shrink: 0;
        }

        /* 長條圖樣式 */
        .bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 100%;
            margin: 0 4px;
            flex-grow: 1;
            max-width: 55px;
            position: relative; 
        }

        .bar {
            width: 100%;
            background-color: var(--unsorted-color);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease, background-color 0.2s;
            min-width: 20px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* 閃爍動畫 */
        @keyframes blink-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); box-shadow: 0 0 10px var(--compare-color); }
            100% { opacity: 1; transform: scale(1); }
        }

        .bar.blinking {
            animation: blink-animation 0.8s infinite;
        }

        .bar.is-sorted { background-color: var(--sorted-color) !important; }
        .bar.is-min { background-color: var(--min-color) !important; }
        .bar.is-comparing { background-color: var(--compare-color) !important; }

        .bar-value { margin-top: 5px; font-weight: bold; font-size: 14px; height: 20px; }
        .bar-index { font-size: 12px; color: #999; height: 15px; margin-bottom: 2px;}

        /* 指示器容器 (i, j, min) */
        .indicator-slot {
            display: flex;
            flex-direction: column; /* 垂直堆疊 */
            align-items: center;
            justify-content: flex-start;
            min-height: 50px; /* 預留高度給堆疊的標籤 */
            width: 100%;
            gap: 2px;
        }
        
        .indicator-tag {
            font-size: 10px; /* 稍微縮小字體以容納 "minIndex" */
            font-weight: bold;
            padding: 1px 2px;
            border-radius: 3px;
            color: white;
            line-height: 1.2;
            width: 95%; /* 盡量利用寬度 */
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap; /* 防止換行 */
            overflow: hidden;
            text-overflow: clip;
        }

        .indicator-i { background-color: var(--loop-outer); }
        .indicator-j { background-color: var(--loop-inner); }
        .indicator-min { background-color: var(--min-color); }

        /* 控制區 */
        .control-panel {
            width: 100%;
            max-width: 1400px;
            margin-top: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .status-text {
            font-size: 18px;
            padding-left: 10px;
            border-left: 5px solid var(--accent-color);
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .buttons { display: flex; justify-content: center; gap: 10px; }
        button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            background-color: var(--accent-color); color: white;
            border: none; border-radius: 5px;
        }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #2980b9; }

        .legend { display: flex; gap: 15px; justify-content: center; font-size: 14px; margin-bottom: 10px; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; }
        .legend-color { width: 12px; height: 12px; margin-right: 5px; border-radius: 2px; }

        @media (max-width: 900px) {
            .main-container { flex-direction: column-reverse; align-items: center; }
            .visualizer-section, .left-panel { width: 100%; min-width: 0; }
        }

    </style>
</head>
<body>

    <h1>選擇排序法：詳細視覺化</h1>
    <p class="subtitle">觀察變量變化、循環結構與比較過程</p>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: var(--loop-outer)"></div>外層 (i)</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--loop-inner)"></div>內層 (j)</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--min-color)"></div>最小值 (minIndex)</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--compare-color)"></div>比較中 (閃爍)</div>
    </div>

    <div class="main-container">
        <!-- 左側：變量與代碼 (現在在左邊) -->
        <div class="left-panel">
            <!-- 變量儀表板 -->
            <div class="variable-dashboard">
                <div class="var-box">
                    <div class="var-label" style="color: var(--loop-outer)">i (外層)</div>
                    <div class="var-value" id="val-i">-</div>
                    <div class="var-sub" id="val-arr-i">arr[i]: -</div>
                </div>
                <div class="var-box">
                    <div class="var-label" style="color: var(--loop-inner)">j (內層)</div>
                    <div class="var-value" id="val-j">-</div>
                    <div class="var-sub" id="val-arr-j">arr[j]: -</div>
                </div>
                <div class="var-box">
                    <div class="var-label" style="color: var(--min-color)">minIndex</div>
                    <div class="var-value" id="val-min">-</div>
                    <div class="var-sub" id="val-arr-min">val: -</div>
                </div>
            </div>

            <!-- 代碼區 -->
            <div class="code-section">
                <!-- 循環標示線 -->
                <div class="loop-indicator loop-outer"><span class="loop-label">外循環</span></div>
                <div class="loop-indicator loop-inner"><span class="loop-label">內循環</span></div>

                <div class="code-line" id="line-1"><span class="line-num">1</span>設 i 由 0 至 n-2</div>
                <div class="code-line" id="line-2"><span class="line-num">2</span>    minIndex = i</div>
                <div class="code-line" id="line-3"><span class="line-num">3</span>    設 j 由 i+1 至 n-1</div>
                <div class="code-line" id="line-4"><span class="line-num">4</span>        如果 array[j] < array[minIndex] 則</div>
                <div class="code-line" id="line-5"><span class="line-num">5</span>            minIndex = j</div>
                <div class="code-line" id="line-6"><span class="line-num">6</span>    如果 minIndex != i 則</div>
                <div class="code-line" id="line-7"><span class="line-num">7</span>        SWAP(array[i], array[minIndex])</div>
            </div>
        </div>

        <!-- 右側：視覺化 (現在在右邊) -->
        <div class="visualizer-section">
            <div class="visualization-box" id="visualizer"></div>
        </div>
    </div>

    <div class="control-panel">
        <div class="status-text" id="status-text">準備就緒</div>
        <div class="buttons">
            <button onclick="init()">重新生成</button>
            <button id="prev-btn" onclick="stepBackward()" disabled>⏮ 上一步</button>
            <button id="next-btn" onclick="stepForward()" disabled>下一步 ⏭</button>
        </div>
    </div>

    <script>
        let array = [];
        let steps = [];
        let currentStepIndex = 0;
        const visualizer = document.getElementById('visualizer');
        const statusText = document.getElementById('status-text');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // 變量顯示元素
        const elVarI = document.getElementById('val-i');
        const elVarArrI = document.getElementById('val-arr-i');
        const elVarJ = document.getElementById('val-j');
        const elVarArrJ = document.getElementById('val-arr-j');
        const elVarMin = document.getElementById('val-min');
        const elVarArrMin = document.getElementById('val-arr-min');

        function init() {
            const count = 8; 
            array = [];
            for (let i = 0; i < count; i++) {
                array.push(Math.floor(Math.random() * 90) + 10);
            }
            calculateSteps();
            currentStepIndex = 0;
            renderStep(0);
        }

        function calculateSteps() {
            steps = [];
            let tempArray = [...array];
            let n = tempArray.length;

            // Helper to create step object
            const addStep = (line, msg, iVal, jVal, minVal, highlight = 'active', isComparing = false) => {
                steps.push({
                    arr: [...tempArray],
                    sortedIndex: iVal - 1, 
                    minIndex: minVal,
                    compareIndex: jVal,
                    activeLine: line,
                    highlightClass: highlight,
                    message: msg,
                    isComparing: isComparing, 
                    vars: {
                        i: iVal,
                        j: jVal,
                        min: minVal,
                        arrI: (iVal >= 0 && iVal < n) ? tempArray[iVal] : '-',
                        arrJ: (jVal >= 0 && jVal < n) ? tempArray[jVal] : '-',
                        arrMin: (minVal >= 0 && minVal < n) ? tempArray[minVal] : '-'
                    }
                });
            };

            // 初始狀態
            addStep(null, "準備開始排序。", -1, -1, -1);

            for (let i = 0; i < n - 1; i++) {
                // Line 1
                addStep('line-1', `外層循環開始：i = ${i}`, i, -1, -1);

                // Line 2
                let minIdx = i;
                addStep('line-2', `設定 minIndex = i (${i})`, i, -1, minIdx);

                for (let j = i + 1; j < n; j++) {
                    // Line 3
                    addStep('line-3', `內層循環：j = ${j}`, i, j, minIdx);

                    // Line 4: 比較步驟，開啟閃爍與詳細文字
                    addStep('line-4', 
                            `正在比較 array[j] (${tempArray[j]}) < array[minIndex] (${tempArray[minIdx]}) ?`, 
                            i, j, minIdx, 'active', true);

                    if (tempArray[j] < tempArray[minIdx]) {
                        minIdx = j;
                        // Line 5
                        addStep('line-5', `發現更小值！更新 minIndex 為 ${j}`, i, j, minIdx, 'active-red');
                    }
                }

                // Line 6
                addStep('line-6', `內層結束。檢查 minIndex (${minIdx}) != i (${i}) ?`, i, -1, minIdx);

                if (minIdx !== i) {
                    // Line 7
                    let temp = tempArray[minIdx];
                    tempArray[minIdx] = tempArray[i];
                    tempArray[i] = temp;
                    
                    steps.push({
                        arr: [...tempArray],
                        sortedIndex: i, 
                        minIndex: i, 
                        compareIndex: -1,
                        activeLine: 'line-7',
                        highlightClass: 'active-green',
                        message: `交換 arr[${i}] 與 arr[${minIdx}]。`,
                        isComparing: false,
                        vars: {
                            i: i, j: -1, min: minIdx,
                            arrI: tempArray[i], arrJ: '-', arrMin: tempArray[minIdx]
                        }
                    });
                } else {
                    steps.push({
                        arr: [...tempArray],
                        sortedIndex: i,
                        minIndex: i,
                        compareIndex: -1,
                        activeLine: 'line-6',
                        message: `無需交換，${tempArray[i]} 已在正確位置。`,
                        isComparing: false,
                        vars: {
                            i: i, j: -1, min: minIdx,
                            arrI: tempArray[i], arrJ: '-', arrMin: tempArray[minIdx]
                        }
                    });
                }
            }

            // 結束
            steps.push({
                arr: [...tempArray],
                sortedIndex: n - 1,
                minIndex: -1,
                compareIndex: -1,
                activeLine: null,
                message: "排序完成！",
                isComparing: false,
                vars: { i: '-', j: '-', min: '-', arrI: '-', arrJ: '-', arrMin: '-' }
            });
        }

        function renderStep(index) {
            const step = steps[index];
            
            // 1. 渲染長條圖
            visualizer.innerHTML = '';
            step.arr.forEach((value, idx) => {
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';

                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${(value / 100) * 80}%`; 

                // 狀態判斷與樣式
                if (idx <= step.sortedIndex && step.sortedIndex !== -1) {
                    bar.classList.add('is-sorted');
                } else if (idx === step.minIndex) {
                    bar.classList.add('is-min');
                    // 如果是比較步驟，且此條是 minIndex，則閃爍
                    if (step.isComparing) bar.classList.add('blinking');
                } else if (idx === step.compareIndex) {
                    bar.classList.add('is-comparing');
                    // 如果是比較步驟，且此條是 j，則閃爍
                    if (step.isComparing) bar.classList.add('blinking');
                }

                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.innerText = value;

                const barIndex = document.createElement('div');
                barIndex.className = 'bar-index';
                barIndex.innerText = idx;

                // 新增：i, j, min 指示器 (支援堆疊)
                const indicatorSlot = document.createElement('div');
                indicatorSlot.className = 'indicator-slot';
                
                let indicatorsHTML = '';
                if (idx === step.vars.i) {
                    indicatorsHTML += '<span class="indicator-tag indicator-i">i</span>';
                }
                if (idx === step.vars.j) {
                    indicatorsHTML += '<span class="indicator-tag indicator-j">j</span>';
                }
                if (idx === step.vars.min) {
                    // 修改這裡：顯示完整的 minIndex
                    indicatorsHTML += '<span class="indicator-tag indicator-min">minIndex</span>';
                }
                indicatorSlot.innerHTML = indicatorsHTML;

                barContainer.appendChild(bar);
                barContainer.appendChild(barValue);
                barContainer.appendChild(barIndex);
                barContainer.appendChild(indicatorSlot); 
                visualizer.appendChild(barContainer);
            });

            // 2. 代碼高亮
            document.querySelectorAll('.code-line').forEach(el => el.className = 'code-line');
            if (step.activeLine) {
                const activeEl = document.getElementById(step.activeLine);
                if (activeEl) activeEl.classList.add(step.highlightClass || 'active');
            }

            // 3. 更新變量儀表板
            const v = step.vars;
            elVarI.innerText = v.i === -1 ? '-' : v.i;
            elVarArrI.innerText = `arr[i]: ${v.arrI}`;
            
            elVarJ.innerText = v.j === -1 ? '-' : v.j;
            elVarArrJ.innerText = `arr[j]: ${v.arrJ}`;
            
            elVarMin.innerText = v.min === -1 ? '-' : v.min;
            elVarArrMin.innerText = `val: ${v.arrMin}`;

            // 4. 更新文字與按鈕
            statusText.innerText = step.message;
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === steps.length - 1;
        }

        function stepForward() {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                renderStep(currentStepIndex);
            }
        }

        function stepBackward() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                renderStep(currentStepIndex);
            }
        }

        window.onload = init;

    </script>
</body>
</html>
