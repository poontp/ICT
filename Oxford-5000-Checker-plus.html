<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oxford Smart Checker (UK/US + Stemming)</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --success-bg: #d1fae5;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            
            /* Level Colors */
            --level-a-bg: #eff6ff;
            --level-a-text: #1e40af;
            --level-b-bg: #fffbeb;
            --level-b-text: #92400e;
            --level-c-bg: #faf5ff;
            --level-c-text: #6b21a8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            line-height: 1.5;
            padding: 2rem 1rem;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: #1e293b;
            flex-wrap: wrap;
        }
        .smart-badge {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            vertical-align: middle;
            white-space: nowrap;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            height: 450px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .card-label { font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        
        /* Inputs */
        textarea {
            flex: 1;
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            resize: none;
            font-family: monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--primary); ring: 2px solid var(--primary); }

        /* Upload Area */
        .upload-area {
            flex: 1;
            border: 2px dashed var(--border);
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            text-align: center;
            padding: 1rem;
        }
        .upload-area:hover { border-color: var(--primary); background: #eff6ff; }
        .upload-area.has-file { border-color: var(--success); background: #f0fdf4; }
        
        .icon-large { width: 48px; height: 48px; margin-bottom: 1rem; color: #94a3b8; }
        .upload-area.has-file .icon-large { color: var(--success); }

        /* Results Section */
        .results-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .results-container.active { display: block; }

        .toolbar {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
        }

        .stats { display: flex; gap: 0.5rem; font-size: 0.875rem; flex-wrap: wrap; }
        .stat-item { padding: 0.35rem 0.75rem; border-radius: 0.375rem; border: 1px solid var(--border); background: white; font-weight: 600; white-space: nowrap; }
        .stat-found { border-color: #bbf7d0; background: #f0fdf4; color: #15803d; }
        .stat-missing { border-color: #fecaca; background: #fef2f2; color: #b91c1c; }

        .controls { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        select, button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
            font-size: 0.875rem;
            cursor: pointer;
            background: white;
        }
        button.btn-primary { background: #1e293b; color: white; border: none; }
        button.btn-primary:hover { background: #0f172a; }

        /* Table */
        .table-wrapper { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th {
            background: #f8fafc;
            text-align: left;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td { padding: 0.85rem 1.5rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }

        /* Status Tags */
        .status-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .status-found { background: var(--success-bg); color: var(--success); }
        .status-missing { background: #f1f5f9; color: var(--text-muted); }
        
        .match-note {
            display: inline-block;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            border: 1px solid;
            white-space: nowrap;
        }
        .note-lemma { color: #d97706; background: #fffbeb; border-color: #fcd34d; }
        .note-variant { color: #0284c7; background: #e0f2fe; border-color: #7dd3fc; }

        /* Level Badges */
        .level-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .level-badge {
            display: flex;
            align-items: center;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border: 1px solid transparent;
        }
        .lvl-A { background: var(--level-a-bg); color: var(--level-a-text); border-color: #bfdbfe; }
        .lvl-B { background: var(--level-b-bg); color: var(--level-b-text); border-color: #fde047; }
        .lvl-C { background: var(--level-c-bg); color: var(--level-c-text); border-color: #e9d5ff; }

        .error-msg {
            color: #dc2626;
            background: #fee2e2;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary);"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
            Oxford 5000 Checker <span class="smart-badge">UK/US + Stemming</span>
        </h1>
        <p style="color: var(--text-muted);">Supports: Plurals, Tenses, UK/US Swapping (Colour ↔ Color, Organise ↔ Organize)</p>
    </header>

    <div class="grid">
        <!-- Text Input -->
        <div class="card">
            <div class="card-header">
                <div class="card-label">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #4f46e5;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    1. Input Word List
                </div>
            </div>
            <textarea id="inputText" placeholder="Paste your words here...&#10;Examples:&#10;coloured (UK Past -> finds color)&#10;organising (UK Continuous -> finds organize)&#10;theatres (UK Plural -> finds theater)"></textarea>
        </div>

        <!-- CSV Upload -->
        <div class="card">
            <div class="card-header">
                <div class="card-label">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #059669;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    2. Upload Oxford CSV
                </div>
                <span id="fileStatus" style="font-size: 0.8rem; color: #6b7280;">No file selected</span>
            </div>
            
            <div class="upload-area" id="dropZone">
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                <div id="uploadPlaceholder">
                    <svg class="icon-large" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <p style="font-weight: bold; color: #374151; margin-bottom: 0.5rem;">Click to Upload CSV</p>
                    <p style="font-size: 0.8rem; color: #9ca3af;">Format: word, class, level</p>
                </div>
                <div id="fileInfo" style="display: none;">
                    <svg class="icon-large" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <p id="fileNameDisplay" style="font-weight: bold; color: #1f2937; font-size: 1.1rem;"></p>
                    <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Click to change file</p>
                </div>
            </div>
            <div id="errorMsg" class="error-msg"></div>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsContainer" class="results-container">
        <div class="toolbar">
            <div class="stats">
                <div class="stat-item">Total: <span id="statTotal">0</span></div>
                <div class="stat-item stat-found">Found: <span id="statFound">0</span></div>
                <div class="stat-item stat-missing">Missing: <span id="statMissing">0</span></div>
            </div>
            <div class="controls">
                <select id="filterSelect">
                    <option value="ALL">Show All</option>
                    <option value="FOUND">Only Found</option>
                    <option value="NOT_FOUND">Only Not Found</option>
                    <option disabled>--- By Level ---</option>
                    <option value="A1">Level A1</option>
                    <option value="A2">Level A2</option>
                    <option value="B1">Level B1</option>
                    <option value="B2">Level B2</option>
                    <option value="C1">Level C1</option>
                    <option value="C2">Level C2</option>
                </select>
                <button id="btnExport" class="btn-primary">Export CSV</button>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th style="width: 30%;">Input Word</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 55%;">Oxford Details (Level & Class)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- State ---
    let csvDataMap = new Map();
    let analysisResults = [];
    let currentFilter = 'ALL';

    // --- DOM Elements ---
    const inputText = document.getElementById('inputText');
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const fileInfo = document.getElementById('fileInfo');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const fileStatus = document.getElementById('fileStatus');
    const errorMsg = document.getElementById('errorMsg');
    
    const resultsContainer = document.getElementById('resultsContainer');
    const tableBody = document.getElementById('tableBody');
    const statTotal = document.getElementById('statTotal');
    const statFound = document.getElementById('statFound');
    const statMissing = document.getElementById('statMissing');
    
    const filterSelect = document.getElementById('filterSelect');
    const btnExport = document.getElementById('btnExport');

    // --- Algorithm: UK/US Spelling & Stemming ---

    // 1. Generate Spelling Variants (UK <-> US)
    function getSpellingVariants(word) {
        const variants = new Set();
        const w = word.toLowerCase();
        
        // Helper: if regex matches, add replacement
        const trySwap = (regex, replacement) => {
            if (regex.test(w)) {
                variants.add(w.replace(regex, replacement));
            }
        };

        // --- Common UK/US Patterns ---
        
        // -our (UK) <-> -or (US)  e.g., colour/color, behaviour/behavior
        trySwap(/our$/, 'or');
        trySwap(/or$/, 'our');
        
        // -ise (UK) <-> -ize (US) e.g., organise/organize
        trySwap(/ise$/, 'ize');
        trySwap(/ize$/, 'ise');
        
        // -yse (UK) <-> -yze (US) e.g., analyse/analyze
        trySwap(/yse$/, 'yze');
        trySwap(/yze$/, 'yse');

        // -re (UK) <-> -er (US) e.g., centre/center, theatre/theater
        trySwap(/re$/, 'er');
        trySwap(/er$/, 're');

        // -ence (UK) <-> -ense (US) e.g., defence/defense
        trySwap(/ence$/, 'ense');
        trySwap(/ense$/, 'ence');

        // -ogue (UK) <-> -og (US) e.g., catalogue/catalog
        trySwap(/ogue$/, 'og');
        trySwap(/og$/, 'ogue');

        // Double L (UK) <-> Single L (US) e.g., cancelled/canceled, travelling/traveling
        if (w.includes('ll')) variants.add(w.replace('ll', 'l'));

        // Irregulars (Hardcoded common ones)
        const irregulars = {
            'programme': 'program', 'program': 'programme',
            'aeroplane': 'airplane', 'airplane': 'aeroplane',
            'maths': 'math', 'math': 'maths',
            'grey': 'gray', 'gray': 'grey',
            'pyjamas': 'pajamas', 'pajamas': 'pyjamas',
            'tyre': 'tire', 'tire': 'tyre'
        };
        if (irregulars[w]) variants.add(irregulars[w]);

        return Array.from(variants);
    }

    // 2. Generate Stemmed Forms
    function getStemmedForms(word) {
        const forms = new Set();
        const w = word.toLowerCase();
        if (w.length < 3) return [];

        // Plural / 3rd Person (s, es, ies)
        if (w.endsWith('ies')) forms.add(w.slice(0, -3) + 'y');
        if (w.endsWith('es')) forms.add(w.slice(0, -2));
        if (w.endsWith('s') && !w.endsWith('ss')) forms.add(w.slice(0, -1));

        // Past (ed, d, ied)
        if (w.endsWith('ied')) forms.add(w.slice(0, -3) + 'y');
        if (w.endsWith('ed')) {
            forms.add(w.slice(0, -1)); // liked -> like
            forms.add(w.slice(0, -2)); // played -> play
            // Double consonant: stopped -> stop
            const base = w.slice(0, -2);
            if (base.length > 2 && base[base.length-1] === base[base.length-2]) {
                forms.add(base.slice(0, -1));
            }
        }

        // Continuous (ing)
        if (w.endsWith('ing')) {
            forms.add(w.slice(0, -3)); // playing -> play
            forms.add(w.slice(0, -3) + 'e'); // making -> make
            // Double consonant: running -> run
            const base = w.slice(0, -3);
            if (base.length > 2 && base[base.length-1] === base[base.length-2]) {
                forms.add(base.slice(0, -1));
            }
        }

        // Adverbs (ly)
        if (w.endsWith('ly')) {
            forms.add(w.slice(0, -2));
            if (w.endsWith('ily')) forms.add(w.slice(0, -3) + 'y');
        }

        return Array.from(forms);
    }

    // 3. Core Search Logic
    function findMatch(inputWord) {
        const lowerInput = inputWord.toLowerCase();

        // A. Exact Match
        if (csvDataMap.has(lowerInput)) {
            return { found: true, type: 'exact', matchWord: lowerInput, data: csvDataMap.get(lowerInput) };
        }

        // B. Check Spelling Variants (e.g. Input: color -> Try: colour)
        const directVariants = getSpellingVariants(lowerInput);
        for (const v of directVariants) {
            if (csvDataMap.has(v)) {
                return { found: true, type: 'variant', matchWord: v, data: csvDataMap.get(v) };
            }
        }

        // C. Check Stemmed Forms (e.g. Input: played -> Try: play)
        const stems = getStemmedForms(lowerInput);
        for (const s of stems) {
            // C1. Stem match
            if (csvDataMap.has(s)) {
                return { found: true, type: 'lemma', matchWord: s, data: csvDataMap.get(s) };
            }
            // C2. Stem + Variant match (e.g. Input: coloured -> Stem: colour -> Try: color)
            const stemVariants = getSpellingVariants(s);
            for (const sv of stemVariants) {
                if (csvDataMap.has(sv)) {
                    return { found: true, type: 'variant_lemma', matchWord: sv, data: csvDataMap.get(sv) };
                }
            }
        }

        return { found: false, type: null, matchWord: null, data: [] };
    }


    // --- Event Listeners ---
    dropZone.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFileUpload(file);
    });

    inputText.addEventListener('input', runAnalysis);

    filterSelect.addEventListener('change', (e) => {
        currentFilter = e.target.value;
        renderTable();
    });

    btnExport.addEventListener('click', exportCSV);

    // --- Logic ---

    function handleFileUpload(file) {
        const reader = new FileReader();
        errorMsg.style.display = 'none';
        
        reader.onload = (e) => {
            try {
                processCSV(e.target.result);
                
                fileNameDisplay.textContent = file.name;
                uploadPlaceholder.style.display = 'none';
                fileInfo.style.display = 'block';
                dropZone.classList.add('has-file');
                fileStatus.textContent = `Loaded ${csvDataMap.size} words`;
                fileStatus.style.color = 'var(--success)';
                
                if (inputText.value.trim()) runAnalysis();

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "CSV Error: " + err.message;
                errorMsg.style.display = 'block';
                csvDataMap.clear();
            }
        };
        reader.readAsText(file);
    }

    function processCSV(text) {
        const lines = text.split(/\r?\n/);
        const newMap = new Map();
        let count = 0;

        lines.forEach(line => {
            if (!line.trim()) return;
            const parts = line.split(',');
            if (parts.length < 2) return;

            const rawWord = parts[0].trim();
            let rawClass = parts.length >= 2 ? parts[1].trim() : '';
            let rawLevel = parts.length >= 3 ? parts[2].trim() : '';

            if (parts.length === 2) {
                rawLevel = rawClass;
                rawClass = '?';
            }

            if (rawWord.toLowerCase() === 'word' && rawLevel.toLowerCase().includes('level')) return;
            if (!rawWord) return;

            const key = rawWord.toLowerCase();
            const entry = {
                original: rawWord,
                class: rawClass,
                level: rawLevel.toUpperCase()
            };

            if (newMap.has(key)) {
                newMap.get(key).push(entry);
            } else {
                newMap.set(key, [entry]);
            }
            count++;
        });

        if (count === 0) throw new Error("No valid data found (Format: word, class, level)");
        csvDataMap = newMap;
    }

    function parseInputText(text) {
        if (!text) return [];
        return text.split(/[\n,;\t]+/).map(w => w.trim()).filter(w => w.length > 0);
    }

    function runAnalysis() {
        const text = inputText.value;
        const words = parseInputText(text);
        
        if (words.length === 0) {
            resultsContainer.classList.remove('active');
            return;
        }

        const uniqueWords = [...new Set(words)];

        analysisResults = uniqueWords.map(inputWord => {
            const result = findMatch(inputWord);
            return {
                input: inputWord,
                found: result.found,
                matchType: result.type,
                matchWord: result.matchWord,
                matches: result.data
            };
        });

        resultsContainer.classList.add('active');
        renderTable();
    }

    function renderTable() {
        let displayData = analysisResults;

        if (currentFilter === 'FOUND') {
            displayData = analysisResults.filter(r => r.found);
        } else if (currentFilter === 'NOT_FOUND') {
            displayData = analysisResults.filter(r => !r.found);
        } else if (currentFilter !== 'ALL') {
            displayData = analysisResults.filter(r => {
                if (!r.found) return false;
                return r.matches.some(m => m.level.includes(currentFilter));
            });
        }

        const total = analysisResults.length;
        const found = analysisResults.filter(r => r.found).length;
        statTotal.textContent = total;
        statFound.textContent = found;
        statMissing.textContent = total - found;

        tableBody.innerHTML = '';
        
        if (displayData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 3rem; color: #9ca3af;">No words match the criteria</td></tr>`;
            return;
        }

        displayData.forEach(item => {
            const tr = document.createElement('tr');
            
            // 1. Input Word Column
            const tdWord = document.createElement('td');
            const wordDiv = document.createElement('div');
            wordDiv.style.fontWeight = '500';
            wordDiv.textContent = item.input;
            tdWord.appendChild(wordDiv);

            if (item.found && item.matchType !== 'exact') {
                const note = document.createElement('div');
                note.className = 'match-note ' + (item.matchType.includes('variant') ? 'note-variant' : 'note-lemma');
                
                let noteText = "";
                if (item.matchType === 'lemma') noteText = `→ ${item.matchWord} (Base)`;
                else if (item.matchType === 'variant') noteText = `→ ${item.matchWord} (UK/US)`;
                else if (item.matchType === 'variant_lemma') noteText = `→ ${item.matchWord} (Var+Base)`;
                
                note.textContent = noteText;
                tdWord.style.display = 'flex';
                tdWord.style.alignItems = 'center';
                tdWord.appendChild(note);
            }
            
            // 2. Status Column
            const tdStatus = document.createElement('td');
            const statusSpan = document.createElement('span');
            statusSpan.className = `status-tag ${item.found ? 'status-found' : 'status-missing'}`;
            statusSpan.textContent = item.found ? 'Found' : 'Not Found';
            tdStatus.appendChild(statusSpan);

            // 3. Details Column
            const tdDetails = document.createElement('td');
            if (item.found) {
                const group = document.createElement('div');
                group.className = 'level-group';
                
                item.matches.forEach(m => {
                    const badge = document.createElement('div');
                    let colorClass = '';
                    if (m.level.startsWith('A')) colorClass = 'lvl-A';
                    else if (m.level.startsWith('B')) colorClass = 'lvl-B';
                    else if (m.level.startsWith('C')) colorClass = 'lvl-C';
                    
                    badge.className = `level-badge ${colorClass}`;
                    badge.textContent = `${m.level} • ${m.class || 'word'}`;
                    group.appendChild(badge);
                });
                tdDetails.appendChild(group);
            } else {
                tdDetails.textContent = '-';
                tdDetails.style.color = '#d1d5db';
            }

            tr.appendChild(tdWord);
            tr.appendChild(tdStatus);
            tr.appendChild(tdDetails);
            tableBody.appendChild(tr);
        });
    }

    function exportCSV() {
        if (analysisResults.length === 0) return;

        const header = "Input Word,Found,Match Type,Matched Word,Max Level,Details\n";
        const rows = analysisResults.map(r => {
            const foundStr = r.found ? 'Yes' : 'No';
            const matchType = r.matchType || '-';
            const matchedWord = r.matchWord || '-';
            const simpleLevel = r.matches.length > 0 ? r.matches[0].level : '-';
            
            const details = r.matches.map(m => `[${m.level}] ${m.class}`).join('; ');
            const safeDetails = `"${details.replace(/"/g, '""')}"`;
            
            return `${r.input},${foundStr},${matchType},${matchedWord},${simpleLevel},${safeDetails}`;
        }).join("\n");

        const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'oxford_smart_check_full.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>