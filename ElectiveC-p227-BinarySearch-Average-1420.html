<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>總比較次數 S 逐步計算 (修正說明版)</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --accent: #e74c3c;
            --highlight: #f1c40f;
            --btn-next: #27ae60;
            --btn-prev: #7f8c8d;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        .main-container {
            max-width: 1100px;
            width: 100%;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            padding: 25px;
            box-sizing: border-box;
        }

        h2 {
            text-align: center;
            margin-top: 0;
            color: var(--primary);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            flex-grow: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        input[type=range] {
            width: 200px;
            cursor: pointer;
        }

        button {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 100px;
        }

        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        
        button:disabled {
            background-color: #bdc3c7 !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #btnPrev { background-color: var(--btn-prev); }
        #btnNext { background-color: var(--btn-next); }
        #btnReset { background-color: var(--primary); }

        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .controls { justify-content: center; }
        }

        .formula-box {
            background: #2c3e50;
            color: #fff;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 140px;
        }

        .formula-row {
            margin: 5px 0;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .formula-highlight {
            color: var(--highlight);
            font-weight: bold;
            font-size: 1.2em;
        }

        .explanation-text {
            font-size: 0.9em;
            color: #bdc3c7;
            margin-top: 5px;
            font-style: italic;
        }

        .result-box {
            background: #fff;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .result-label {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--accent);
        }

        .tree-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ecf0f1;
            border-radius: 12px;
            min-height: 400px;
            display: flex;
            justify-content: center;
            padding-top: 20px;
        }

        .node-group { transition: opacity 0.4s ease; }
        .node-group.dimmed { opacity: 0.15; }

        circle {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.4s;
        }

        circle.active-layer {
            stroke: var(--highlight);
            stroke-width: 5px;
            filter: drop-shadow(0 0 10px var(--highlight));
            r: 20;
        }

        text {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            font-weight: bold;
        }

        line {
            stroke: #bdc3c7;
            stroke-width: 2px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #eee;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--btn-next);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>

<div class="main-container">
    <h2>對分檢索：總比較次數 (S) 計算演示</h2>

    <div class="controls">
        <div class="slider-group">
            <label for="nRange">資料量 (N): <span id="nDisplay" style="color:var(--accent); font-weight:bold;">15</span></label>
            <input type="range" id="nRange" min="1" max="63" value="15">
        </div>
        <div class="btn-group">
            <button id="btnReset" onclick="resetAll()">⟲ 重置</button>
            <button id="btnPrev" onclick="changeStep(-1)" disabled>← 上一步</button>
            <button id="btnNext" onclick="changeStep(1)">下一步 →</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="formula-box" id="formulaBox">
            <!-- Content injected by JS -->
        </div>
        <div class="result-box">
            <div class="result-label">目前累計總次數 (S)</div>
            <div class="result-value" id="totalS">0</div>
            <div class="result-label" id="avgLabel" style="margin-top:10px; font-size:0.8em;"></div>
        </div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="tree-container" id="viz"></div>
</div>

<script>
    const nRange = document.getElementById('nRange');
    const nDisplay = document.getElementById('nDisplay');
    const vizDiv = document.getElementById('viz');
    const totalSEl = document.getElementById('totalS');
    const formulaBox = document.getElementById('formulaBox');
    const avgLabel = document.getElementById('avgLabel');
    const progressFill = document.getElementById('progressFill');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    const NODE_R = 16;
    const LEVEL_H = 70;
    
    let currentN = 15;
    let treeData = null;
    let maxDepth = 0;
    let currentStep = 0; 

    function init() {
        updateTree(parseInt(nRange.value));
        nRange.addEventListener('input', (e) => {
            updateTree(parseInt(e.target.value));
        });
    }

    function updateTree(n) {
        currentN = n;
        nDisplay.textContent = n;
        maxDepth = 0;
        treeData = buildBST(1, n, 1);
        render(treeData);
        resetAll();
    }

    function resetAll() {
        currentStep = 0;
        renderState();
    }

    function changeStep(delta) {
        const targetStep = currentStep + delta;
        if (targetStep >= 0 && targetStep <= maxDepth + 1) {
            currentStep = targetStep;
            renderState();
        }
    }

    function renderState() {
        btnPrev.disabled = (currentStep === 0);
        btnNext.disabled = (currentStep === maxDepth + 1);
        nRange.disabled = (currentStep !== 0);

        let runningTotal = 0;
        let formulaHTML = '';
        let avgText = '';

        if (currentStep === 0) {
            formulaHTML = `
                <div class="formula-row">準備就緒</div>
                <div class="explanation-text">點擊 [下一步] 開始計算每一層的比較成本</div>
            `;
            totalSEl.textContent = "0";
            progressFill.style.width = "0%";
        } 
        else if (currentStep <= maxDepth) {
            // Calculate previous layers
            for(let d=1; d<currentStep; d++) {
                runningTotal += getCountAtDepth(d) * d;
            }
            
            // Current layer calculation
            const d = currentStep;
            const count = getCountAtDepth(d);
            const subTotal = count * d;
            runningTotal += subTotal;

            formulaHTML = `
                <div class="formula-row">第 <span class="formula-highlight">${d}</span> 層 (需比較 ${d} 次)</div>
                <div class="formula-row">節點數: ${count} 個</div>
                <div class="formula-row">本層成本: ${count} × ${d} = <span class="formula-highlight">${subTotal}</span></div>
                <div class="explanation-text">解釋：找到這 ${count} 個數字中的任何一個，都需要從根節點往下走 ${d} 步。</div>
            `;
            
            totalSEl.textContent = runningTotal;
            const pct = (currentStep / (maxDepth + 1)) * 100;
            progressFill.style.width = `${pct}%`;
        } 
        else {
            // Finished
            for(let d=1; d<=maxDepth; d++) {
                runningTotal += getCountAtDepth(d) * d;
            }
            
            formulaHTML = `
                <div class="formula-row" style="color:#2ecc71">計算完成！</div>
                <div class="formula-row">總比較次數 S = <span class="formula-highlight">${runningTotal}</span></div>
                <div class="explanation-text">所有節點被找到所需的比較次數總和</div>
            `;
            totalSEl.textContent = runningTotal;
            avgText = `平均 = ${runningTotal} / ${currentN} ≈ ${(runningTotal/currentN).toFixed(2)}`;
            progressFill.style.width = "100%";
        }

        formulaBox.innerHTML = formulaHTML;
        avgLabel.textContent = avgText;
        updateVisuals();
    }

    function updateVisuals() {
        const groups = document.querySelectorAll('.node-group');
        groups.forEach(g => {
            const depth = parseInt(g.getAttribute('data-depth'));
            const circle = g.querySelector('circle');
            g.classList.remove('dimmed');
            circle.classList.remove('active-layer');

            if (currentStep === 0) {
                g.classList.add('dimmed');
            } else if (currentStep <= maxDepth) {
                if (depth === currentStep) circle.classList.add('active-layer');
                else if (depth > currentStep) g.classList.add('dimmed');
            }
        });
    }

    function getCountAtDepth(d) {
        return document.querySelectorAll(`.node-group[data-depth="${d}"]`).length;
    }

    function buildBST(start, end, depth) {
        if (start > end) return null;
        const mid = Math.floor((start + end) / 2);
        if (depth > maxDepth) maxDepth = depth;
        return {
            val: mid,
            depth: depth,
            left: buildBST(start, mid - 1, depth + 1),
            right: buildBST(mid + 1, end, depth + 1)
        };
    }

    function render(root) {
        vizDiv.innerHTML = '';
        if(!root) return;

        const width = Math.max(vizDiv.clientWidth, currentN * 35);
        const height = (maxDepth + 1) * LEVEL_H;
        
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("width", width);
        svg.setAttribute("height", height);
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

        let counter = 0;
        const nodePositions = new Map(); 

        function traverseAndDraw(node) {
            if(!node) return;
            traverseAndDraw(node.left);
            counter++;
            const x = (width / (currentN + 1)) * counter;
            const y = node.depth * LEVEL_H;
            nodePositions.set(node.val, {x, y});
            traverseAndDraw(node.right);
        }
        
        traverseAndDraw(root);

        function drawLines(node) {
            if(!node) return;
            const pos = nodePositions.get(node.val);
            if(node.left) {
                const childPos = nodePositions.get(node.left.val);
                addLine(svg, pos.x, pos.y, childPos.x, childPos.y);
                drawLines(node.left);
            }
            if(node.right) {
                const childPos = nodePositions.get(node.right.val);
                addLine(svg, pos.x, pos.y, childPos.x, childPos.y);
                drawLines(node.right);
            }
        }
        drawLines(root);

        function drawNodes(node) {
            if(!node) return;
            const pos = nodePositions.get(node.val);
            
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", "node-group dimmed");
            g.setAttribute("data-depth", node.depth);

            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", pos.x);
            circle.setAttribute("cy", pos.y);
            circle.setAttribute("r", NODE_R);
            circle.setAttribute("fill", getDepthColor(node.depth));
            
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", pos.x);
            text.setAttribute("y", pos.y);
            text.textContent = node.val;

            g.appendChild(circle);
            g.appendChild(text);
            svg.appendChild(g);

            drawNodes(node.left);
            drawNodes(node.right);
        }
        drawNodes(root);

        vizDiv.appendChild(svg);
    }

    function addLine(svg, x1, y1, x2, y2) {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y1);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y2);
        svg.appendChild(line);
    }

    function getDepthColor(d) {
        const colors = ['#3498db', '#9b59b6', '#2ecc71', '#e67e22', '#f1c40f', '#e74c3c'];
        return colors[(d-1) % colors.length];
    }

    init();
</script>

</body>
</html>