<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無人機程式設計互動教學</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
            --grid-line-color: #ccc;
            --drone-color: #d0021b;
            --path-color: #4a4a4a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 1em;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background-color: #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 12px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #495057;
            transition: background-color 0.3s, color 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-button:hover:not(.active) {
            background-color: #dee2e6;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .grid-container {
            flex: 1;
            min-width: 300px;
            aspect-ratio: 1 / 1;
        }

        .controls-and-info {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-panel, .explanation-panel, .controls-panel, .code-panel {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
        }

        .controls-panel {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .control-btn.reset {
            background-color: white;
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .control-btn:hover {
            opacity: 0.85;
        }
        
        .control-btn:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 8px;
            align-items: center;
        }

        .info-grid span:first-child {
            font-weight: 600;
        }

        .code-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-family: "Courier New", Courier, monospace;
        }
        
        .code-list li {
            padding: 5px 8px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .code-list li.current-step {
            background-color: var(--secondary-color);
            color: white;
            font-weight: bold;
        }

        .explanation-panel p {
            margin: 0;
        }
        
        .final-answer {
            margin-top: 10px !important;
            padding: 10px;
            background-color: #e7f3ff;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            font-weight: bold;
        }

        .drone-arrow {
            fill: var(--drone-color);
            transition: transform 0.4s ease-in-out;
        }

        .path-line {
            stroke: var(--path-color);
            stroke-width: 2.5;
            stroke-linecap: round;
        }
        
        .code-fill {
            font-weight: bold;
            color: var(--drone-color);
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            .main-layout {
                flex-direction: column;
            }
            .grid-container {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-button active" onclick="showPart('a')">問題 (a)</button>
        <button class="tab-button" onclick="showPart('b')">問題 (b)</button>
        <button class="tab-button" onclick="showPart('c')">問題 (c)</button>
        <button class="tab-button" onclick="showPart('d')">問題 (d)</button>
    </div>

    <!-- Part (a) -->
    <div id="part-a" class="tab-content active">
        <h2>(a) 追蹤路徑</h2>
        <div class="main-layout">
            <div class="grid-container" id="grid-a"></div>
            <div class="controls-and-info">
                <div class="controls-panel">
                    <button id="next-a" class="control-btn">下一步</button>
                    <button id="reset-a" class="control-btn reset">重置</button>
                </div>
                <div class="info-panel">
                    <div class="info-grid">
                        <span>目前位置:</span> <span id="pos-a">(4, 3)</span>
                        <span>目前方向:</span> <span id="dir-a">北</span>
                        <span>執行指令:</span> <span id="cmd-a">尚未開始</span>
                    </div>
                </div>
                <div class="code-panel">
                    <p><strong>程式:</strong></p>
                    <ul id="code-list-a" class="code-list">
                        <li>TL</li>
                        <li>FW</li>
                        <li>FW</li>
                        <li>FW</li>
                        <li>TR</li>
                        <li>FW</li>
                        <li>FW</li>
                    </ul>
                </div>
                <div class="explanation-panel">
                    <p id="exp-a">無人機初始位置在 (4, 3)，面向北方。請點擊「下一步」開始執行程式。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Part (b) -->
    <div id="part-b" class="tab-content">
        <h2>(b) 完成子程式 TL</h2>
        <div class="main-layout">
            <div class="grid-container" id="grid-b"></div>
            <div class="controls-and-info">
                <div class="controls-panel">
                    <button id="next-b" class="control-btn">下一步</button>
                    <button id="reset-b" class="control-btn reset">重置</button>
                </div>
                <div class="info-panel">
                     <div class="info-grid">
                        <span>目前位置:</span> <span id="pos-b">(3, 3)</span>
                        <span>目前方向:</span> <span id="dir-b">北</span>
                        <span>執行指令:</span> <span id="cmd-b">尚未開始</span>
                    </div>
                </div>
                <div class="explanation-panel">
                    <p id="exp-b">
                        子程式 TL 的功能是「將無人機向逆時針轉 90 度」。我們只有 TR (順時針轉 90 度) 可以用。
                        <br>逆時針轉 90 度，效果等同於順時針轉 270 度，也就是連續執行 3 次 TR。
                        <br>點擊「下一步」觀看動畫。
                    </p>
                    <div class="code-panel" style="margin-top:10px;">
                        <p><strong>子程式 TL:</strong></p>
                        <p>設 i 由 <span class="code-fill">1</span> 至 <span class="code-fill">3</span></p>
                        <p style="padding-left: 20px;">TR</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Part (c) -->
    <div id="part-c" class="tab-content">
        <h2>(c) 完成子程式 SQ(N)</h2>
        <div class="main-layout">
            <div class="grid-container" id="grid-c"></div>
            <div class="controls-and-info">
                <div class="controls-panel">
                    <button id="next-c" class="control-btn">下一步</button>
                    <button id="reset-c" class="control-btn reset">重置</button>
                </div>
                <div class="info-panel">
                     <div class="info-grid">
                        <span>目前位置:</span> <span id="pos-c">(2, 2)</span>
                        <span>目前方向:</span> <span id="dir-c">北</span>
                        <span>執行指令:</span> <span id="cmd-c">尚未開始</span>
                    </div>
                </div>
                <div class="explanation-panel">
                    <p id="exp-c">
                        子程式 SQ(N) 用來畫一個邊長為 N 的正方形。畫正方形需要重複「前進 N 格、轉彎 90 度」這個動作 4 次。
                        <br>因此，迴圈需要從 1 執行到 4。我們將以範例 SQ(3) 來演示。
                        <br>點擊「下一步」觀看動畫。
                    </p>
                    <div class="code-panel" style="margin-top:10px;">
                        <p><strong>子程式 SQ(N):</strong></p>
                        <p>設 i 由 <span class="code-fill">1</span> 至 <span class="code-fill">4</span></p>
                        <p style="padding-left: 20px;">(重複 N 次 FW)</p>
                        <p style="padding-left: 20px;">TR</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Part (d) -->
    <div id="part-d" class="tab-content">
        <h2>(d) 執行程式</h2>
        <div class="main-layout">
            <div class="grid-container" id="grid-d"></div>
            <div class="controls-and-info">
                <div class="controls-panel">
                    <button id="next-d" class="control-btn">下一步</button>
                    <button id="reset-d" class="control-btn reset">重置</button>
                </div>
                <div class="info-panel">
                     <div class="info-grid">
                        <span>目前位置:</span> <span id="pos-d">(1, 1)</span>
                        <span>目前方向:</span> <span id="dir-d">北</span>
                        <span>執行指令:</span> <span id="cmd-d">尚未開始</span>
                    </div>
                </div>
                <div class="code-panel">
                    <p><strong>程式:</strong></p>
                    <p>設 i 由 1 至 2</p>
                    <p style="padding-left: 20px;">SQ(i)</p>
                    <ul id="code-list-d" class="code-list">
                        <!-- Will be populated by JS -->
                    </ul>
                </div>
                <div class="explanation-panel">
                    <p id="exp-d">
                        此程式先執行 SQ(1)，再執行 SQ(2)。無人機從 (1,1) 面向北方開始。
                        <br>點擊「下一步」開始執行。
                    </p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const parts = ['a', 'b', 'c', 'd'];
    const directions = ['北', '東', '南', '西']; // 0:N, 1:E, 2:S, 3:W
    const moves = [
        { dx: 0, dy: 1 },  // North
        { dx: 1, dy: 0 },  // East
        { dx: 0, dy: -1 }, // South
        { dx: -1, dy: 0 }  // West
    ];

    let states = {};

    function createGrid(containerId, partId, size = 6) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("viewBox", "-20 -20 340 340");
        svg.style.width = "100%";
        svg.style.height = "100%";

        const cellSize = 300 / size;

        // Grid lines and labels
        for (let i = 0; i <= size; i++) {
            // Y-axis labels (1 to 6)
            if (i < size) {
                const yLabel = document.createElementNS(svgNS, "text");
                yLabel.setAttribute("x", -10);
                yLabel.setAttribute("y", (size - 1 - i) * cellSize + cellSize / 2 + 5);
                yLabel.setAttribute("text-anchor", "middle");
                yLabel.setAttribute("font-size", "12");
                yLabel.textContent = i + 1;
                svg.appendChild(yLabel);
            }
             // X-axis labels (1 to 6)
            if (i < size) {
                const xLabel = document.createElementNS(svgNS, "text");
                xLabel.setAttribute("x", i * cellSize + cellSize / 2);
                xLabel.setAttribute("y", 315);
                xLabel.setAttribute("text-anchor", "middle");
                xLabel.setAttribute("font-size", "12");
                xLabel.textContent = i + 1;
                svg.appendChild(xLabel);
            }
            
            // Grid lines
            const hLine = document.createElementNS(svgNS, "line");
            hLine.setAttribute("x1", 0);
            hLine.setAttribute("y1", i * cellSize);
            hLine.setAttribute("x2", 300);
            hLine.setAttribute("y2", i * cellSize);
            hLine.setAttribute("stroke", "var(--grid-line-color)");
            svg.appendChild(hLine);

            const vLine = document.createElementNS(svgNS, "line");
            vLine.setAttribute("x1", i * cellSize);
            vLine.setAttribute("y1", 0);
            vLine.setAttribute("x2", i * cellSize);
            vLine.setAttribute("y2", 300);
            vLine.setAttribute("stroke", "var(--grid-line-color)");
            svg.appendChild(vLine);
        }
        
        const pathGroup = document.createElementNS(svgNS, "g");
        pathGroup.id = `path-${partId}`;
        svg.appendChild(pathGroup);

        const drone = document.createElementNS(svgNS, "polygon");
        drone.id = `drone-${partId}`;
        drone.classList.add('drone-arrow');
        drone.setAttribute("points", "-8,10 0,-10 8,10");
        svg.appendChild(drone);
        
        container.appendChild(svg);
    }
    
    function toSvgCoords(x, y, size = 6) {
        const cellSize = 300 / size;
        return {
            x: (x - 1) * cellSize + cellSize / 2,
            y: (size - y) * cellSize + cellSize / 2
        };
    }

    function updateDroneTransform(partId, x, y, dir, size = 6) {
        const svgCoords = toSvgCoords(x, y, size);
        const rotation = dir * 90;
        const drone = document.getElementById(`drone-${partId}`);
        if (drone) {
            drone.setAttribute("transform", `translate(${svgCoords.x}, ${svgCoords.y}) rotate(${rotation})`);
        }
    }

    function drawPath(partId, x1, y1, x2, y2, size = 6) {
        const svgCoords1 = toSvgCoords(x1, y1, size);
        const svgCoords2 = toSvgCoords(x2, y2, size);
        
        const pathGroup = document.getElementById(`path-${partId}`);
        const svgNS = "http://www.w3.org/2000/svg";
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", svgCoords1.x);
        line.setAttribute("y1", svgCoords1.y);
        line.setAttribute("x2", svgCoords2.x);
        line.setAttribute("y2", svgCoords2.y);
        line.classList.add('path-line');
        pathGroup.appendChild(line);
    }
    
    function updateUI(partId) {
        const state = states[partId];
        document.getElementById(`pos-${partId}`).textContent = `(${state.x}, ${state.y})`;
        document.getElementById(`dir-${partId}`).textContent = directions[state.dir];
        
        // *** FIX: Handle the initial state (step = -1) to prevent error ***
        let commandLabel;
        if (state.step === -1) {
            commandLabel = "尚未開始";
        } else if (state.step < state.commands.length) {
            commandLabel = state.commands[state.step].label;
        } else {
            commandLabel = "結束";
        }
        document.getElementById(`cmd-${partId}`).textContent = commandLabel;
        
        if (document.getElementById(`code-list-${partId}`)) {
            const codeItems = document.querySelectorAll(`#code-list-${partId} li`);
            codeItems.forEach((item, index) => {
                item.classList.toggle('current-step', index === state.step);
            });
        }
        
        // This function call will now reliably execute on initial setup
        updateDroneTransform(partId, state.x, state.y, state.dir);
    }

    function setupPart(partId) {
        createGrid(`grid-${partId}`, partId);
        
        let initialState = {};
        switch(partId) {
            case 'a':
                initialState = {
                    x: 4, y: 3, dir: 0, step: -1,
                    commands: [
                        { op: 'TL', label: 'TL' }, { op: 'FW', label: 'FW' }, { op: 'FW', label: 'FW' },
                        { op: 'FW', label: 'FW' }, { op: 'TR', label: 'TR' }, { op: 'FW', label: 'FW' },
                        { op: 'FW', label: 'FW' }
                    ]
                };
                document.getElementById('exp-a').innerHTML = '無人機初始位置在 (4, 3)，面向北方。請點擊「下一步」開始執行程式。';
                break;
            case 'b':
                initialState = {
                    x: 3, y: 3, dir: 0, step: -1,
                    commands: [
                        { op: 'TR', label: 'TR (1/3)' },
                        { op: 'TR', label: 'TR (2/3)' },
                        { op: 'TR', label: 'TR (3/3)' }
                    ]
                };
                document.getElementById('exp-b').innerHTML = '逆時針轉 90 度 (TL) 等同於順時針轉 3 次 90 度 (TR)。點擊「下一步」觀看效果。';
                break;
            case 'c':
                const sq3_commands = [];
                for(let i=1; i<=4; i++) {
                    for(let j=1; j<=3; j++) {
                        sq3_commands.push({ op: 'FW', label: `第 ${i} 邊: 前進 (${j}/3)`});
                    }
                    sq3_commands.push({ op: 'TR', label: `第 ${i} 邊: 轉向`});
                }
                initialState = {
                    x: 2, y: 2, dir: 0, step: -1,
                    commands: sq3_commands
                };
                document.getElementById('exp-c').innerHTML = '以 SQ(3) 為例，重複「前進 3 格、轉彎」4 次。點擊「下一步」開始繪製正方形。';
                break;
            case 'd':
                const sq_d_commands = [];
                const codeListD = document.getElementById('code-list-d');
                codeListD.innerHTML = '';
                
                let flatStepIndex = 0;
                // SQ(1)
                let li_sq1 = document.createElement('li');
                li_sq1.textContent = '執行 SQ(1)';
                li_sq1.style.fontWeight = 'bold';
                codeListD.appendChild(li_sq1);
                sq_d_commands[flatStepIndex++] = { op: 'META', label: '執行 SQ(1)' };
                for(let i=1; i<=4; i++) {
                    sq_d_commands[flatStepIndex++] = { op: 'FW', label: `SQ(1) 邊${i}: 前進` };
                    sq_d_commands[flatStepIndex++] = { op: 'TR', label: `SQ(1) 邊${i}: 轉向` };
                }

                // SQ(2)
                let li_sq2 = document.createElement('li');
                li_sq2.textContent = '執行 SQ(2)';
                li_sq2.style.fontWeight = 'bold';
                codeListD.appendChild(li_sq2);
                sq_d_commands[flatStepIndex++] = { op: 'META', label: '執行 SQ(2)' };
                for(let i=1; i<=4; i++) {
                    sq_d_commands[flatStepIndex++] = { op: 'FW', label: `SQ(2) 邊${i}: 前進 (1/2)` };
                    sq_d_commands[flatStepIndex++] = { op: 'FW', label: `SQ(2) 邊${i}: 前進 (2/2)` };
                    sq_d_commands[flatStepIndex++] = { op: 'TR', label: `SQ(2) 邊${i}: 轉向` };
                }

                initialState = {
                    x: 1, y: 1, dir: 0, step: -1,
                    commands: sq_d_commands
                };
                document.getElementById('exp-d').innerHTML = '此程式先執行 SQ(1)，再執行 SQ(2)。無人機從 (1,1) 面向北方開始。<br>點擊「下一步」開始執行。';
                break;
        }
        
        states[partId] = initialState;
        document.getElementById(`next-${partId}`).disabled = false;
        updateUI(partId);
    }

    function step(partId) {
        const state = states[partId];
        if (state.step + 1 >= state.commands.length) {
            document.getElementById(`next-${partId}`).disabled = true;
            return;
        }
        
        state.step++;
        const command = state.commands[state.step];
        const oldPos = { x: state.x, y: state.y };
        let explanation = '';

        switch(command.op) {
            case 'FW':
                const move = moves[state.dir];
                state.x += move.dx;
                state.y += move.dy;
                drawPath(partId, oldPos.x, oldPos.y, state.x, state.y);
                explanation = `執行 <strong>${command.label}</strong>：從 (${oldPos.x}, ${oldPos.y}) 向${directions[state.dir]}移動至 (${state.x}, ${state.y})。`;
                break;
            case 'TR':
                const oldDir = state.dir;
                state.dir = (state.dir + 1) % 4;
                explanation = `執行 <strong>${command.label}</strong>：從面向「${directions[oldDir]}」順時針旋轉 90 度，變為面向「${directions[state.dir]}」。`;
                break;
            case 'TL':
                const oldDirTL = state.dir;
                state.dir = (state.dir + 3) % 4;
                explanation = `執行 <strong>${command.label}</strong>：從面向「${directions[oldDirTL]}」逆時針旋轉 90 度，變為面向「${directions[state.dir]}」。`;
                break;
            case 'META': // For commands that don't move the drone
                 explanation = `開始執行 <strong>${command.label}</strong>。`;
                 step(partId); // Immediately execute next step
                 return;
        }
        
        updateUI(partId);
        document.getElementById(`exp-${partId}`).innerHTML = explanation;
        
        if (state.step + 1 >= state.commands.length) {
            document.getElementById(`next-${partId}`).disabled = true;
            let finalAnswer = '';
            switch(partId) {
                case 'a':
                    finalAnswer = `程式執行完畢。<br><div class="final-answer">最終位置: (${state.x}, ${state.y})<br>最終方向: ${directions[state.dir]}</div>`;
                    break;
                case 'b':
                    finalAnswer = `動畫結束。執行 3 次 TR 後，無人機完成了一次逆時針 90 度轉彎 (TL)。<br><div class="final-answer">答案：設 i 由 1 至 3</div>`;
                    break;
                case 'c':
                    finalAnswer = `SQ(3) 執行完畢，畫出了一個 3x3 的正方形。<br><div class="final-answer">答案：設 i 由 1 至 4</div>`;
                    break;
                case 'd':
                    finalAnswer = `程式執行完畢。<br><div class="final-answer">最終位置: (${state.x}, ${state.y})<br>最終方向: ${directions[state.dir]}</div>`;
                    break;
            }
            document.getElementById(`exp-${partId}`).innerHTML += finalAnswer;
        }
    }

    function showPart(partId) {
        parts.forEach(p => {
            document.getElementById(`part-${p}`).classList.remove('active');
            document.querySelector(`.tab-button[onclick="showPart('${p}')"]`).classList.remove('active');
        });
        document.getElementById(`part-${partId}`).classList.add('active');
        document.querySelector(`.tab-button[onclick="showPart('${partId}')"]`).classList.add('active');
        
        setupPart(partId);
    }

    window.onload = () => {
        parts.forEach(p => {
            document.getElementById(`next-${p}`).addEventListener('click', () => step(p));
            document.getElementById(`reset-${p}`).addEventListener('click', () => setupPart(p));
        });
        showPart('a');
    };
</script>

</body>
</html>
