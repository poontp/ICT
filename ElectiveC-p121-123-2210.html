<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沙盒遊戲程式解題（3D互動版）</title>
    <style>
        :root {
            --cube-size: 20px; /* 控制3D方塊大小 */
            --scene-size: calc(var(--cube-size) * 12);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #0056b3;
            border-bottom: 2px solid #eef;
            padding-bottom: 10px;
        }
        .speed-control-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .speed-control-container label { font-weight: bold; color: #495057; }
        .speed-control-container input[type="range"] { flex-grow: 1; cursor: pointer; max-width: 300px; }
        .speed-control-container span { font-family: "Courier New", Courier, monospace; font-weight: bold; background-color: #e9ecef; padding: 2px 8px; border-radius: 4px; min-width: 25px; text-align: center; }
        .question-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .controls { margin-top: 10px; }
        .button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-top: 10px; transition: background-color 0.2s; }
        .button:hover:not(:disabled) { background-color: #0056b3; }
        .button:disabled { background-color: #aaa; cursor: not-allowed; }
        .code-block { background-color: #eef; border-left: 4px solid #007bff; padding: 15px; margin-top: 15px; border-radius: 4px; font-family: "Courier New", Courier, monospace; font-size: 15px; white-space: pre-wrap; }
        .highlight { background-color: #fff799; border-radius: 3px; display: inline-block; width: calc(100% - 10px); padding: 2px 5px; box-sizing: border-box; transition: background-color 0.1s ease-in-out; }
        .answer-box { display: none; margin-top: 15px; }
        .static-answer { background-color: #e6f7ff; border: 1px solid #91d5ff; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .flex-container { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; }
        .flex-item { flex: 1; min-width: 300px; }
        .variable-tracker { margin-top: 15px; padding: 12px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; font-size: 14px; font-family: "Courier New", Courier, monospace; min-height: 20px; }
        .variable-tracker strong { color: #495057; }
        .variable-tracker code { background-color: #d6eaff; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #004085; }

        /* --- 2D Grid Styles --- */
        .grid-container { display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); width: 100%; max-width: 400px; aspect-ratio: 1 / 1; border: 1px solid #ccc; margin-top: 15px; background-color: #fff; }
        .grid-cell { border: 1px solid #eee; box-sizing: border-box; transition: background-color 0.3s ease; }
        .grid-cell.filled { background-color: #8dbbd2; border: 1px solid #7cacbf; }
        .grid-cell.removed { background-color: #fff; }

        /* --- 3D Scene Styles --- */
        .scene-3d-wrapper {
            position: relative;
            padding-top: 10px;
        }
        .scene-3d-info {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none; /* So it doesn't interfere with dragging */
        }
        .scene-3d {
            width: var(--scene-size);
            height: var(--scene-size);
            max-width: 100%;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
            perspective: 2000px;
            cursor: grab;
        }
        .scene-3d:active { cursor: grabbing; }
        .pivot {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.1s linear;
        }
        .world {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            /* Center the 10x10x10 grid inside the scene */
            transform: translateX(calc(var(--cube-size) * -5)) translateY(calc(var(--cube-size) * -5)) translateZ(calc(var(--cube-size) * -5));
        }
        .cube {
            width: var(--cube-size);
            height: var(--cube-size);
            position: absolute;
            transform-style: preserve-3d;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none; /* Hide cubes are not interactive */
        }
        .cube.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .face {
            position: absolute;
            width: var(--cube-size);
            height: var(--cube-size);
            background: rgba(239, 154, 154, 0.9); /* #ef9a9a */
            border: 1px solid #e57373;
            box-sizing: border-box;
        }
        .face.front  { transform: rotateY(0deg) translateZ(calc(var(--cube-size) / 2)); }
        .face.back   { transform: rotateY(180deg) translateZ(calc(var(--cube-size) / 2)); }
        .face.right  { transform: rotateY(90deg) translateZ(calc(var(--cube-size) / 2)); background: rgba(229, 115, 115, 0.9); } /* #e57373 */
        .face.left   { transform: rotateY(-90deg) translateZ(calc(var(--cube-size) / 2)); background: rgba(229, 115, 115, 0.9); }
        .face.top    { transform: rotateX(90deg) translateZ(calc(var(--cube-size) / 2)); background: rgba(244, 187, 187, 0.9); } /* Lighter */
        .face.bottom { transform: rotateX(-90deg) translateZ(calc(var(--cube-size) / 2)); background: rgba(211, 95, 95, 0.9); } /* Darker */
    </style>
</head>
<body>

    <div class="container">
        <h1>沙盒遊戲程式解題（3D互動版）</h1>
        <p>這是一個互動式解答頁面。點擊「執行動畫」觀看自動播放，或使用「上一步」、「下一步」按鈕來逐一檢視程式碼的執行過程。對於 (e) 至 (h) 題，您可以在模型上按住滑鼠左鍵並拖曳以旋轉視角。</p>
        
        <div class="speed-control-container">
            <label for="speed-slider">動畫速度:</label>
            <span>慢</span>
            <input type="range" id="speed-slider" min="1" max="100" value="90">
            <span>快</span>
            <label>當前值: <span id="speed-value">90</span></label>
        </div>

        <!-- Questions (a) to (d) - 2D Grids -->
        <div class="question-card">
            <h2>(a) - (d) 二維建構問題</h2>
            <p>這些問題在二維平面 (X, Y) 上進行，使用下方對應的 2D 網格進行演示。</p>
            <!-- (a) -->
            <h4>(a) 建造等邊三角形物件</h4>
            <div class="flex-container">
                <div class="flex-item"><div id="grid-a" class="grid-container"></div></div>
                <div class="flex-item">
                    <div class="controls">
                        <button class="button" id="run-a" onclick="runFullAnimation('a')">執行動畫</button>
                        <button class="button" id="prev-a" onclick="stepBackward('a')">上一步</button>
                        <button class="button" id="next-a" onclick="stepForward('a')">下一步</button>
                        <button class="button" onclick="resetAnimation('a')">重置</button>
                    </div>
                    <div id="answer-a" class="answer-box"><div class="code-block" id="code-container-a"><div id="code-a-1">設 x 由 1 至 10</div><div id="code-a-2" style="padding-left: 1em;">設 y 由 x 至 10</div><div id="code-a-3" style="padding-left: 2em;">在 (x, y) 加入一個方塊</div></div><div class="variable-tracker" id="variable-tracker-a"></div></div>
                </div>
            </div>
             <!-- (b) -->
            <h4 style="margin-top: 2em;">(b) 編寫子程式 tri(n)</h4>
            <div class="flex-container">
                <div class="flex-item"><div id="grid-b" class="grid-container"></div></div>
                <div class="flex-item">
                    <div class="controls">
                        <button class="button" id="run-b" onclick="runFullAnimation('b')">執行 tri(4) 動畫</button>
                        <button class="button" id="prev-b" onclick="stepBackward('b')">上一步</button>
                        <button class="button" id="next-b" onclick="stepForward('b')">下一步</button>
                        <button class="button" onclick="resetAnimation('b')">重置</button>
                    </div>
                    <div id="answer-b" class="answer-box"><div class="code-block" id="code-container-b"><div id="code-b-1">子程式 tri(n)</div><div id="code-b-2" style="padding-left: 1em;">設 x 由 1 至 n</div><div id="code-b-3" style="padding-left: 2em;">設 y 由 10 - n + x 至 10</div><div id="code-b-4" style="padding-left: 3em;">在 (x, y) 加入一個方塊</div></div><div class="variable-tracker" id="variable-tracker-b"></div></div>
                </div>
            </div>
            <!-- (c) & (d) -->
            <h4 style="margin-top: 2em;">(c) & (d) 編寫子程式 hole(t)</h4>
            <div class="flex-container">
                <div class="flex-item"><div id="grid-c" class="grid-container"></div></div>
                <div class="flex-item">
                    <div class="controls">
                        <button class="button" id="run-c" onclick="runFullAnimation('c')">執行 hole(3) 動畫</button>
                        <button class="button" id="prev-c" onclick="stepBackward('c')">上一步</button>
                        <button class="button" id="next-c" onclick="stepForward('c')">下一步</button>
                        <button class="button" onclick="resetAnimation('c')">重置</button>
                    </div>
                    <div id="answer-c" class="answer-box"><div class="code-block" id="code-container-c"><div id="code-c-1">子程式 hole(t)</div><div id="code-c-2" style="padding-left: 1em;">square(10)</div><div id="code-c-3" style="padding-left: 1em;">設 x 由 t + 1 至 10 - t</div><div id="code-c-4" style="padding-left: 2em;">設 y 由 t + 1 至 10 - t</div><div id="code-c-5" style="padding-left: 3em;">在 (x, y) 移除一個方塊</div></div><div class="variable-tracker" id="variable-tracker-c"></div></div>
                </div>
            </div>
        </div>

        <!-- Question (e) - 3D -->
        <div class="question-card">
            <h2>(e) 分析 `hole(t)` 與 `UP` 指令 (3D)</h2>
            <p>子程式 `hole(t)` 能建構出 `n x n x 1` 的空心空間。下圖是 `hole(4)`, `UP`, `hole(4)` 的成品。</p>
            <div class="flex-container">
                <div class="flex-item">
                    <div class="scene-3d-wrapper">
                        <div class="scene-3d-info">拖曳可旋轉模型</div>
                        <div id="scene-e" class="scene-3d">
                            <div id="pivot-e" class="pivot">
                                <div id="world-e" class="world"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-item">
                    <div class="static-answer"><h3>問題解析</h3><p>根據 (d) 題 `hole(t)` 的定義，移除方塊的範圍是 `x` 和 `y` 均由 `t+1` 至 `10-t`。空心空間的邊長 `n` 為 `(10-t) - (t+1) + 1 = 10 - 2t`。在題目給出的例子 `hole(4)` 中，輸入參數 `t = 4`，空心空間尺寸 `n = 10 - 2 * 4 = 2`，即 `2 x 2` 的空間。</p></div>
                    <div class="controls">
                        <button class="button" id="run-e" onclick="runFullAnimation('e')">執行動畫</button>
                        <button class="button" id="prev-e" onclick="stepBackward('e')">上一步</button>
                        <button class="button" id="next-e" onclick="stepForward('e')">下一步</button>
                        <button class="button" onclick="resetAnimation('e')">重置</button>
                    </div>
                    <div id="answer-e" class="answer-box"><h3>動畫演示偽代碼</h3><div class="code-block" id="code-container-e"><div id="code-e-1">hole(4)  (在 z=1)</div><div id="code-e-2">UP</div><div id="code-e-3">hole(4)  (在 z=2)</div></div><div class="variable-tracker" id="variable-tracker-e"></div></div>
                </div>
            </div>
        </div>

        <!-- Question (f) - 3D -->
        <div class="question-card">
            <h2>(f) 描述偽代碼建構的物件 (3D)</h2>
            <p>描述由以下偽代碼所建構出來的物件：</p>
            <div class="flex-container">
                <div class="flex-item">
                    <div class="scene-3d-wrapper">
                        <div class="scene-3d-info">拖曳可旋轉模型</div>
                        <div id="scene-f" class="scene-3d">
                            <div id="pivot-f" class="pivot">
                                <div id="world-f" class="world"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-item">
                    <div class="static-answer"><h3>物件描述</h3><p>`square(3)` 建構一個 `3 x 3 x 1` 的實心正方形。`UP` 指令將建造高度加一。連續執行三次 `square(3)` 並用 `UP` 隔開，會堆疊出三層 `3 x 3` 的正方形。因此，最終物件是一個 <strong>`3 x 3 x 3` 的實心立方體</strong>。</p></div>
                    <div class="controls">
                        <button class="button" id="run-f" onclick="runFullAnimation('f')">執行動畫</button>
                        <button class="button" id="prev-f" onclick="stepBackward('f')">上一步</button>
                        <button class="button" id="next-f" onclick="stepForward('f')">下一步</button>
                        <button class="button" onclick="resetAnimation('f')">重置</button>
                    </div>
                    <div id="answer-f" class="answer-box"><h3>動畫演示偽代碼</h3><div class="code-block" id="code-container-f"><div id="code-f-1">square(3) (在 z=1)</div><div id="code-f-2">UP</div><div id="code-f-3">square(3) (在 z=2)</div><div id="code-f-4">UP</div><div id="code-f-5">square(3) (在 z=3)</div></div><div class="variable-tracker" id="variable-tracker-f"></div></div>
                </div>
            </div>
        </div>

        <!-- Question (g) - 3D -->
        <div class="question-card">
            <h2>(g) 建構實心三角柱體 (3D)</h2>
            <p>以下是一個 `10x10x10` 的實心三角柱體，寫出建構出此物件的偽代碼。</p>
            <div class="flex-container">
                <div class="flex-item">
                    <div class="scene-3d-wrapper">
                        <div class="scene-3d-info">拖曳可旋轉模型</div>
                        <div id="scene-g" class="scene-3d">
                            <div id="pivot-g" class="pivot">
                                <div id="world-g" class="world"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-item">
                    <div class="controls">
                        <button class="button" id="run-g" onclick="runFullAnimation('g')">執行動畫</button>
                        <button class="button" id="prev-g" onclick="stepBackward('g')">上一步</button>
                        <button class="button" id="next-g" onclick="stepForward('g')">下一步</button>
                        <button class="button" onclick="resetAnimation('g')">重置</button>
                    </div>
                    <div id="answer-g" class="answer-box">
                        <div class="code-block" id="code-container-g">
                            <div id="code-g-1">設 i 由 1 至 10</div>
                            <div id="code-g-2" style="padding-left: 1em;">tri(10)</div>
                            <div id="code-g-3" style="padding-left: 1em;">UP</div>
                        </div>
                        <div class="variable-tracker" id="variable-tracker-g"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question (h) - 3D -->
        <div class="question-card">
            <h2>(h) 建構三角錐體 (3D)</h2>
            <p>以下是一個由多個等邊三角形建構的三角錐體，寫出建構出此物件的偽代碼。</p>
            <div class="flex-container">
                <div class="flex-item">
                    <div class="scene-3d-wrapper">
                        <div class="scene-3d-info">拖曳可旋轉模型</div>
                        <div id="scene-h" class="scene-3d">
                            <div id="pivot-h" class="pivot">
                                <div id="world-h" class="world"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-item">
                    <div class="controls">
                        <button class="button" id="run-h" onclick="runFullAnimation('h')">執行動畫</button>
                        <button class="button" id="prev-h" onclick="stepBackward('h')">上一步</button>
                        <button class="button" id="next-h" onclick="stepForward('h')">下一步</button>
                        <button class="button" onclick="resetAnimation('h')">重置</button>
                    </div>
                    <div id="answer-h" class="answer-box">
                        <div class="code-block" id="code-container-h">
                            <div id="code-h-1">設 i 由 10 下至 1</div>
                            <div id="code-h-2" style="padding-left: 1em;">tri(i)</div>
                            <div id="code-h-3" style="padding-left: 1em;">UP</div>
                        </div>
                        <div class="variable-tracker" id="variable-tracker-h"></div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        const grid_size = 10;
        let highlightedCodeLineId = null;

        const animationStates = {
            a: { steps: [], currentIndex: -1, isAutoRunning: false }, b: { steps: [], currentIndex: -1, isAutoRunning: false },
            c: { steps: [], currentIndex: -1, isAutoRunning: false }, e: { steps: [], currentIndex: -1, isAutoRunning: false },
            f: { steps: [], currentIndex: -1, isAutoRunning: false }, g: { steps: [], currentIndex: -1, isAutoRunning: false },
            h: { steps: [], currentIndex: -1, isAutoRunning: false }
        };

        const sleep = ms => new Promise(res => setTimeout(res, ms));

        function highlightLine(id) {
            if (highlightedCodeLineId) {
                const prevEl = document.getElementById(highlightedCodeLineId);
                if (prevEl) prevEl.classList.remove('highlight');
            }
            if (id) {
                const currentEl = document.getElementById(id);
                if (currentEl) {
                    currentEl.classList.add('highlight');
                    highlightedCodeLineId = id;
                }
            } else { highlightedCodeLineId = null; }
        }

        function updateVariableDisplay(type, variables) {
            const container = document.getElementById(`variable-tracker-${type}`);
            if (!container) return;
            if (!variables || Object.keys(variables).length === 0) {
                container.innerHTML = '變數追蹤...'; return;
            }
            let html = '';
            for (const [key, value] of Object.entries(variables)) {
                html += `<strong>${key}:</strong> <code>${value}</code>&nbsp;&nbsp;&nbsp;`;
            }
            container.innerHTML = html.trim();
        }

        // --- 2D Grid Functions ---
        function createGrid(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            for (let r = grid_size; r >= 1; r--) {
                for (let c = 1; c <= grid_size; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.id = `${containerId}-cell-${c}-${r}`;
                    container.appendChild(cell);
                }
            }
        }
        function fillCell(prefix, x, y) { const cell = document.getElementById(`grid-${prefix}-cell-${x}-${y}`); if (cell) { cell.classList.remove('removed'); cell.classList.add('filled'); } }
        function clearCell(prefix, x, y) { const cell = document.getElementById(`grid-${prefix}-cell-${x}-${y}`); if (cell) { cell.classList.remove('filled'); cell.classList.add('removed'); } }
        function clearGrid(prefix) { document.querySelectorAll(`#grid-${prefix} .grid-cell`).forEach(cell => cell.classList.remove('filled', 'removed')); }

        // --- 3D Scene Functions ---
        function create3DScene(prefix) {
            const world = document.getElementById(`world-${prefix}`);
            if (!world) return;
            world.innerHTML = '';
            const cubeSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cube-size'));

            for (let z = 1; z <= 10; z++) {
                for (let y = 1; y <= 10; y++) {
                    for (let x = 1; x <= 10; x++) {
                        const cube = document.createElement('div');
                        cube.className = 'cube';
                        cube.id = `cube-${prefix}-${x}-${y}-${z}`;
                        cube.style.transform = `translateX(${ (x - 1) * cubeSize}px) translateY(${ (10 - y) * cubeSize}px) translateZ(${ (z - 1) * cubeSize}px)`;
                        
                        const faces = ['front', 'back', 'left', 'right', 'top', 'bottom'];
                        faces.forEach(faceName => {
                            const face = document.createElement('div');
                            face.className = `face ${faceName}`;
                            cube.appendChild(face);
                        });
                        world.appendChild(cube);
                    }
                }
            }
        }

        function showCube(prefix, x, y, z) { const cube = document.getElementById(`cube-${prefix}-${x}-${y}-${z}`); if (cube) cube.classList.add('visible'); }
        function hideCube(prefix, x, y, z) { const cube = document.getElementById(`cube-${prefix}-${x}-${y}-${z}`); if (cube) cube.classList.remove('visible'); }
        function clear3DScene(prefix) { document.querySelectorAll(`#world-${prefix} .cube`).forEach(cube => cube.classList.remove('visible')); }

        function setup3DRotation(prefix) {
            const scene = document.getElementById(`scene-${prefix}`);
            const pivot = document.getElementById(`pivot-${prefix}`);
            if (!scene || !pivot) return;

            let isDragging = false;
            let previousX, previousY;
            let rotX = -25; // Initial rotation
            let rotY = -45;

            pivot.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;

            scene.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousX = e.clientX;
                previousY = e.clientY;
            });
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - previousX;
                const deltaY = e.clientY - previousY;
                previousX = e.clientX;
                previousY = e.clientY;
                rotY += deltaX * 0.5;
                rotX -= deltaY * 0.5;
                rotX = Math.max(-90, Math.min(90, rotX)); // Clamp vertical rotation
                pivot.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
            });
            window.addEventListener('mouseup', () => { isDragging = false; });
        }


        // --- Animation Step Generation ---
        function generateSteps(type) {
            const steps = [];
            switch(type) {
                case 'a':
                    for (let x = 1; x <= 10; x++) {
                        steps.push({ action: 'highlight', codeLineId: 'code-a-1', variables: { x } });
                        for (let y = x; y <= 10; y++) {
                            steps.push({ action: 'highlight', codeLineId: 'code-a-2', variables: { x, y } });
                            steps.push({ action: 'add', x, y, codeLineId: 'code-a-3', variables: { x, y } });
                        }
                    }
                    break;
                case 'b':
                    const n_b = 4;
                    steps.push({ action: 'highlight', codeLineId: 'code-b-1', variables: { n: n_b } });
                    for (let x = 1; x <= n_b; x++) {
                        steps.push({ action: 'highlight', codeLineId: 'code-b-2', variables: { n: n_b, x } });
                        const startY = 10 - n_b + x;
                        for (let y = startY; y <= 10; y++) {
                            steps.push({ action: 'highlight', codeLineId: 'code-b-3', variables: { n: n_b, x, y, '10-n+x': startY } });
                            steps.push({ action: 'add', x, y, codeLineId: 'code-b-4', variables: { n: n_b, x, y } });
                        }
                    }
                    break;
                case 'c':
                    const t_c = 3;
                    steps.push({ action: 'highlight', codeLineId: 'code-c-1', variables: { t: t_c } });
                    steps.push({ action: 'fill_all', codeLineId: 'code-c-2', variables: { t: t_c } });
                    const startRange = t_c + 1, endRange = 10 - t_c;
                    for (let x = startRange; x <= endRange; x++) {
                        steps.push({ action: 'highlight', codeLineId: 'code-c-3', variables: { t: t_c, x, 't+1': startRange, '10-t': endRange } });
                        for (let y = startRange; y <= endRange; y++) {
                            steps.push({ action: 'highlight', codeLineId: 'code-c-4', variables: { t: t_c, x, y } });
                            steps.push({ action: 'remove', x, y, codeLineId: 'code-c-5', variables: { t: t_c, x, y } });
                        }
                    }
                    break;
                case 'e': {
                    const t = 4;
                    // Layer 1: hole(4) at z=1
                    steps.push({ action: 'highlight', codeLineId: 'code-e-1', variables: { Z: 1, t: 4 } });
                    for (let x = 1; x <= 10; x++) for (let y = 1; y <= 10; y++) steps.push({ action: 'add_cube', x, y, z: 1, codeLineId: 'code-e-1', variables: { Z: 1, t: 4, x, y } });
                    const start = t + 1, end = 10 - t;
                    for (let x = start; x <= end; x++) for (let y = start; y <= end; y++) steps.push({ action: 'remove_cube', x, y, z: 1, codeLineId: 'code-e-1', variables: { Z: 1, t: 4, x, y } });
                    // UP
                    steps.push({ action: 'highlight', codeLineId: 'code-e-2', variables: { Z: 2, t: 4 } });
                    // Layer 2: hole(4) at z=2
                    steps.push({ action: 'highlight', codeLineId: 'code-e-3', variables: { Z: 2, t: 4 } });
                    for (let x = 1; x <= 10; x++) for (let y = 1; y <= 10; y++) steps.push({ action: 'add_cube', x, y, z: 2, codeLineId: 'code-e-3', variables: { Z: 2, t: 4, x, y } });
                    for (let x = start; x <= end; x++) for (let y = start; y <= end; y++) steps.push({ action: 'remove_cube', x, y, z: 2, codeLineId: 'code-e-3', variables: { Z: 2, t: 4, x, y } });
                    break;
                }
                case 'f': {
                    const n = 3;
                    // Layer 1: square(3) at z=1
                    steps.push({ action: 'highlight', codeLineId: 'code-f-1', variables: { Z: 1, n: 3 } });
                    for (let x = 1; x <= n; x++) for (let y = 1; y <= n; y++) steps.push({ action: 'add_cube', x, y, z: 1, codeLineId: 'code-f-1', variables: { Z: 1, n: 3, x, y } });
                    // UP
                    steps.push({ action: 'highlight', codeLineId: 'code-f-2', variables: { Z: 2, n: 3 } });
                    // Layer 2: square(3) at z=2
                    steps.push({ action: 'highlight', codeLineId: 'code-f-3', variables: { Z: 2, n: 3 } });
                    for (let x = 1; x <= n; x++) for (let y = 1; y <= n; y++) steps.push({ action: 'add_cube', x, y, z: 2, codeLineId: 'code-f-3', variables: { Z: 2, n: 3, x, y } });
                    // UP
                    steps.push({ action: 'highlight', codeLineId: 'code-f-4', variables: { Z: 3, n: 3 } });
                    // Layer 3: square(3) at z=3
                    steps.push({ action: 'highlight', codeLineId: 'code-f-5', variables: { Z: 3, n: 3 } });
                    for (let x = 1; x <= n; x++) for (let y = 1; y <= n; y++) steps.push({ action: 'add_cube', x, y, z: 3, codeLineId: 'code-f-5', variables: { Z: 3, n: 3, x, y } });
                    break;
                }
                case 'g':
                    for (let i = 1; i <= 10; i++) {
                        const z = i;
                        steps.push({ action: 'highlight', codeLineId: 'code-g-1', variables: { i, Z: z } });
                        const n_g = 10;
                        steps.push({ action: 'highlight', codeLineId: 'code-g-2', variables: { i, n: n_g, Z: z } });
                        for (let x = 1; x <= n_g; x++) {
                            // Note: The triangle shape from (a) is y from x to 10.
                            for (let y = x; y <= n_g; y++) {
                                steps.push({ action: 'add_cube', x, y, z, codeLineId: 'code-g-2', variables: { i, n: n_g, Z: z, x, y } });
                            }
                        }
                        if (i < 10) {
                            steps.push({ action: 'highlight', codeLineId: 'code-g-3', variables: { i, 'Next Z': z + 1 } });
                        }
                    }
                    break;
                case 'h':
                    // This logic now matches the provided correct answer: loop i from 10 down to 1, call tri(i), then UP.
                    for (let i = 10; i >= 1; i--) {
                        const z = 11 - i; // When i=10, z=1. When i=1, z=10.
                        
                        // Highlight the outer loop line
                        steps.push({ action: 'highlight', codeLineId: 'code-h-1', variables: { i, Z: z } });
                        
                        // Highlight the tri(i) call
                        steps.push({ action: 'highlight', codeLineId: 'code-h-2', variables: { i, Z: z } });

                        // Expand tri(i) based on the definition from (b)
                        const n = i;
                        for (let x = 1; x <= n; x++) {
                            const startY = 10 - n + x;
                            for (let y = startY; y <= 10; y++) {
                                steps.push({
                                    action: 'add_cube', x, y, z,
                                    codeLineId: 'code-h-2', // Keep tri(i) highlighted
                                    variables: { i, Z: z, x, y }
                                });
                            }
                        }

                        // Highlight the UP call (if not the last iteration)
                        if (i > 1) {
                            steps.push({ action: 'highlight', codeLineId: 'code-h-3', variables: { i, 'Next Z': z + 1 } });
                        }
                    }
                    break;
            }
            return steps;
        }
        
        // --- Control Functions ---
        function updateButtonStates(type) {
            const state = animationStates[type];
            const prevButton = document.getElementById(`prev-${type}`);
            const nextButton = document.getElementById(`next-${type}`);
            const runButton = document.getElementById(`run-${type}`);

            if (prevButton) prevButton.disabled = state.currentIndex < 0 || state.isAutoRunning;
            if (nextButton) nextButton.disabled = (state.steps.length > 0 && state.currentIndex >= state.steps.length - 1) || state.isAutoRunning;
            if (runButton) runButton.disabled = state.isAutoRunning;
        }

        function initAnimation(type) {
            const state = animationStates[type];
            if (state.isAutoRunning) return;
            if (state.steps.length === 0) {
                resetAnimation(type); 
                state.steps = generateSteps(type);
            }
            document.getElementById(`answer-${type}`).style.display = 'block';
            updateButtonStates(type);
        }

        function resetAnimation(type) {
            const state = animationStates[type];
            state.isAutoRunning = false; 
            state.currentIndex = -1;
            state.steps = []; 
            
            const is3D = ['e', 'f', 'g', 'h'].includes(type);
            if (is3D) { clear3DScene(type); } else { clearGrid(type); }
            
            document.getElementById(`answer-${type}`).style.display = 'none';
            highlightLine(null);
            updateVariableDisplay(type, null);
            updateButtonStates(type);
        }

        function stepForward(type) {
            const state = animationStates[type];
            if (state.isAutoRunning) return;
            if (state.steps.length === 0) initAnimation(type);
            if (state.currentIndex >= state.steps.length - 1) return;
            if (state.currentIndex === -1) document.getElementById(`answer-${type}`).style.display = 'block';

            state.currentIndex++;
            const step = state.steps[state.currentIndex];
            
            highlightLine(step.codeLineId);
            updateVariableDisplay(type, step.variables);

            switch(step.action) {
                case 'add': fillCell(type, step.x, step.y); break;
                case 'remove': clearCell(type, step.x, step.y); break;
                case 'fill_all':
                    for (let i = 1; i <= 10; i++) for (let j = 1; j <= 10; j++) fillCell(type, i, j);
                    break;
                case 'add_cube': showCube(type, step.x, step.y, step.z); break;
                case 'remove_cube': hideCube(type, step.x, step.y, step.z); break;
            }
            updateButtonStates(type);
        }

        function stepBackward(type) {
            const state = animationStates[type];
            if (state.isAutoRunning || state.currentIndex < 0) return;

            const currentStep = state.steps[state.currentIndex];

            // Perform the reverse action
            switch(currentStep.action) {
                case 'add': clearCell(type, currentStep.x, currentStep.y); break;
                case 'remove': fillCell(type, currentStep.x, currentStep.y); break;
                case 'fill_all': clearGrid(type); break;
                case 'add_cube': hideCube(type, currentStep.x, currentStep.y, currentStep.z); break;
                case 'remove_cube': showCube(type, currentStep.x, currentStep.y, currentStep.z); break;
            }

            state.currentIndex--;

            if (state.currentIndex < 0) {
                highlightLine(null);
                updateVariableDisplay(type, null);
            } else {
                const prevStep = state.steps[state.currentIndex];
                highlightLine(prevStep.codeLineId);
                updateVariableDisplay(type, prevStep.variables);
            }

            updateButtonStates(type);
        }

        async function runFullAnimation(type) {
            const state = animationStates[type];
            if (state.isAutoRunning) return;

            resetAnimation(type);
            initAnimation(type);
            
            state.isAutoRunning = true;
            updateButtonStates(type);
            
            let delay = calculateDelay(document.getElementById('speed-slider').value);
            
            // Speed up very long animations automatically
            if (state.steps.length > 500) delay = Math.max(1, delay / 10);

            for (let i = 0; i < state.steps.length; i++) {
                if (!state.isAutoRunning) break; 
                state.currentIndex = i;
                const step = state.steps[i];
                
                highlightLine(step.codeLineId);
                updateVariableDisplay(type, step.variables);

                let shouldSleep = true;
                switch(step.action) {
                    case 'add': fillCell(type, step.x, step.y); break;
                    case 'remove': clearCell(type, step.x, step.y); break;
                    case 'fill_all': for (let i = 1; i <= 10; i++) for (let j = 1; j <= 10; j++) fillCell(type, i, j); break;
                    case 'add_cube': showCube(type, step.x, step.y, step.z); break;
                    case 'remove_cube': hideCube(type, step.x, step.y, step.z); break;
                    case 'highlight': shouldSleep = false; break; // Don't pause on highlight-only steps
                }
                if (shouldSleep) await sleep(delay);
            }
            
            state.isAutoRunning = false;
            updateButtonStates(type);
        }

        // --- Speed Control Logic ---
        function calculateDelay(sliderValue) {
            const MAX_DELAY = 500, MIN_DELAY = 1;
            return MAX_DELAY - ((sliderValue - 1) / 99) * (MAX_DELAY - MIN_DELAY);
        }

        window.onload = () => {
            ['a', 'b', 'c'].forEach(type => { createGrid(`grid-${type}`); resetAnimation(type); });
            ['e', 'f', 'g', 'h'].forEach(type => { create3DScene(type); setup3DRotation(type); resetAnimation(type); });

            const speedSlider = document.getElementById('speed-slider');
            const speedValueDisplay = document.getElementById('speed-value');
            speedValueDisplay.textContent = speedSlider.value;
            
            speedSlider.addEventListener('input', (e) => { speedValueDisplay.textContent = e.target.value; });
        };
    </script>

</body>
</html>